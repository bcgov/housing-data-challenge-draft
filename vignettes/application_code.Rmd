---
title: "Application code"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Application code}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE}
library(bchousing)
```

The application code is structured as an R package, deployed on GitHub. As such, 
it contains some common files and directories required for the app to be considered
an R package. This makes it possible and easier to scale, test and deploy the app.
It also takes care of dependencies as defined in package DESCRIPTION file, as well as
individual package functions roxygen documentation.

The application package is initialized using [Golem R package](https://github.com/ThinkR-open/golem),
which heavily relies upon [usethis R package](https://usethis.r-lib.org) for its utility functions
when building an R package.

## Notable files and directories and their usage

In general, the content of the application directory satisifes the requirements of

- R package definition
- Git repository
- the aplication itself
- specific requirements defined by policies on [bcgov GitHub profile](https://github.com/bcgov)
- package documentation
- shinyapps.io deployment

### Files and directories required by R package definition

There main resource on building R packages is Hadley Wickham's book [R Packages](http://r-pkgs.had.co.nz). Some other useful resources can be found at the following links:

- [R package primer](https://kbroman.org/pkg_primer/) by Karl Broman
- [Writing an R package from scratch](https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/) by Hilary Parker

Following is the list of files and directories (identified by trailing slash character, `/`)
required by R package definition:

- `data/` - Data objects used by Shiny application
- `data-raw/` - scripts and raw data based on which data objects used by Shiny application are created
- `DESCRIPTION` - package metadata
- `inst/` - installed files, custom CSS and JavaScript files
- `man/` - package objects documentation
- `NAMESPACE` - namespaces of dependencies used in the application
- `R/` - code for package functions (used by Shiny application and scripts for getting data)
- `tests/` - application unit tests

We will expand a little bit more on each of them.

#### `data/` directory

This is the directory where data objects used by the application are stored. 
These objects are based on raw data obtained from different open data sources,
saved using `usethis::use_data` R function in `.rda` format. It includes property 
transfer tax data used on the application home page (`ptt_prov_dash.rda`), 
mothly property transfer tax data for each geographical level (development region,
regional district and municipality), as well as `sf` objects containing boundaries 
files for mapping the property transfer tax data.

More details can be found in [External data](http://r-pkgs.had.co.nz/data.html)
section of Hadley's book.

#### `data-raw/` directory

Scripts and raw data used for creating the data objects used by the application are
stored in this directory. There are scripts for getting census data and property 
transfer tax data and they are stored in separate directories.

These scripts and their usage are documented in more details in vignettes 
[Getting census data](getting-census-data.html) and [Getting Property Transfer Tax 
data](getting-ptt-data.html) respectively.

#### `DESCRIPTION` file

This file contains metadata about the package. The metadata includes package name,
title, description information. It also includes information about package authors,
maintainers and contributors, and more.

Most importantly, it includes the information about dependencies used by the application.
These dependencies are listed in `Imports` and `Remotes` sections. When a new package
dependency is introduced into the application, it needs to be included here. 

If the new package is available on CRAN, it should be listed in the `Imports` sections.

Similarly, if the new dependency is installed from a remote location (like GitHub),
it should be listed in the `Remotes` section.

More details can be found in [Package metadata](http://r-pkgs.had.co.nz/description.html)
section of Hadley's book.

#### `inst/` directory

Upon package installation, the content of `inst/` directory is copied into the 
top-level package directory. For Shiny applications, this is where we put custom 
CSS and JS files.

In this directory, `bchousing` app also stores static `.Rmd` files that are used 
in `About` section of the application.

More general details can be found in [Installed files](http://r-pkgs.had.co.nz/inst.html)
section of Hadley's book.

#### `man/` directory

Files in this directory are auto0generated by Roxygen when building the package
and they contain documenation for the package objects based on Roxygen comments 
defined for them.

More details can be found in [Object documentation](http://r-pkgs.had.co.nz/man.html)
section of Hadley's book.

#### `NAMESPACE` file

This file is generally used when deploying to CRAN. It lists all the dependcies 
(other packages and their functions) that the application depends on.

This file should not be modified by hand. It is auto-generated when building a 
package after an update (using `devtools::build()` function).

More details can be found in [Namespace](http://r-pkgs.had.co.nz/namespace.html)
section of Hadley's book.

#### `R/` directory

In this directory, we store all the scripts that hold internal functions
written to be used withing the application. Some of them are used for the Shiny 
application portion of the package, while the others are helper functions used 
in scripts that get and wrangle raw census and property transfer tax data.

All functions in these files contain Roxygen comments which make it possible
to generate with clear instructions for their usage in package documentation, as well as
in auto-complete pop-up windows in modern code editors like RStudio.

Package `bchousing` contains the following R scripts, grouped into categories 
based on their usage:

- Shiny application
  - `run_app.R` - contains the function that initializes the Shiny app
  - `app_ui.R` - all UI code for the Shiny app that defines the application layout
  - `app_server.R` - all server code for the Shiny app that defines the application logic
  - `app_data.R` - package data not marked as `internal` (PTT and boundaries shape files)
  - `app_helpers.R` - various helper functions used by the Shiny application
  - `sysdata.R` - package data marked as `internal` (census data)
- Data wrangling
  - `cleaning_data.R` - various helper functions used by scripts in `data-raw/` directory
  to wrangle the data before saving the data objects into `data/` directory.

More general details about `R/` directory can be found in [R code](http://r-pkgs.had.co.nz/r.html)
section of Hadley's book.

#### `tests/` directory

Application unit tests should be stored in this directory. Currently no tests 
have been developed for the package.

More general details about package testing can be found in [Testing](http://r-pkgs.had.co.nz/tests.html)
section of Hadley's book.

### Files required by git

In the root directory, the file used by git is `.gitignore`. It stores files that 
are not tracked by git and wouldn't be found within the repository.

If new files are added to the application but need not be a part of the repo (for various
reasons), their file names should be added to `.gitignore` in separate lines and 
changes to `.gitignore` committed.

There is also `README.Rmd` file (and its knitted `readme.md` version) that are not
specifically required by git, but it is simply a common practice to have it in place
to briefly describe the specifics of the repository.

### Files and directories required by the application

There are a few of files and directories in the repository that are not part of 
the R package definition, but are used specifically by the application itself 
at some point to work as intended. They are:

- `.Renviron`
- `app.R`
- `cache/`

#### `.Renviron` file

This file is used to store environment variables and loaded during the application 
start-up or when loading the project in RStudio.

In the context of `bchousing` application, this is where [CensusMapper](https://censusmapper.ca) 
API key is saved into `cancensus.api_key` environment variable. This variable 
is used for getting census data using [`cancensus` R package](https://mountainmath.github.io/cancensus/index.html),
which is powered by CensusMapper, as described in 
[Getting census data](getting-census-data.html) vignette.

File `.Renviron` is git-ignored, so analyst's API key is safe.

#### `app.R` file

This R script is used to intialize the app from RStudio or R console.

#### `cache/` directory

This directory is a storage for temporary files whe getting census data.
There are two kinds of temporary files that are stored here:

1. Files cached by `cancensus` package functions, to save on CensusMapper API usage
quotas when fethcing census data for the combination of census year, level, 
variables and region.
2. Files cached by `data-raw/census/get_census_data.R` script when wrangling the 
data before finally saving it into `R/sysdata.R` to be used by the package.

This directory is git-ignored.

### Package documentation

Package documentation is built using [`pkgdown` R package](https://pkgdown.r-lib.org).
The following files and directories in the `bchousing` package are related to it:

- `_pkgdown.yml`
- `docs/`
- `vignettes/`

Here's a brief description for each of them.

#### `_pkgdown.yml` file

This file stores the configuration for the documentation website built by 
`pkgdown` package. Configuration includes the definition of the layout,
content of navigation menu, grouping of list of package objects, etc.

#### `docs/` directory

This directory stores the HTML files generated by `pkgdown` package based on 
the content of `vignettes/` directory.

More details about `pkgdown` R package and its usage can be found at the [package
documentation website](https://pkgdown.r-lib.org).

#### `vignettes/` directory

This directory stores the vignettes for the package and its notable functions. 
They are written as RMarkdown files.

### Files and directories required for shinyapps.io deployment

Some specific files and directories in the repository are needed for deployment to
shinyapps.io. They are:

- `app_file_manifest` - it contains a list of files and directories that should be deployed
to shinyapps.io when using the R console command for deployment
- `rsconnect` - this directory is autogenerated and it contains the credentials 
and some other details required for the deployment

### Common files or required by [bcgov GitHub profile](https://github.com/bcgov) policies

There are some common files in the repository. They include:

- `CODE_OF_CONDUCT.md`
- `LICENSE`
- `README.Rmd` and it's knitted version `readme.md`
